<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qur'an</title>
    <link href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>" rel="icon">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa+Ink:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">



    <style>
        /* --- Base & Typography --- */
        :root {
            /* Using --vh for mobile browser viewport height consistency */
            --vh: 100vh;
        }

        html {
            box-sizing: border-box;
            font-size: 62.5%; /* Makes 1rem = 10px, for easier math */
        }

        *,
        *::before,
        *::after {
            box-sizing: inherit;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000000;
            color: #ffffff;
            line-height: 1.6;
            font-size: 1.6rem; /* Default 16px */
            overscroll-behavior: none;
            overflow: hidden; /* No scrolling on the main page */
        }

        /* --- Main Layout --- */
        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: var(--vh, 100vh);
            padding: 2rem;
            padding-bottom: 12rem; /* Leave space for controls at the bottom */
        }

        /* --- Content Display (The Text) --- */
        #content-display {
            text-align: center;
            width: 100%;
            max-width: 1200px; /* Max width for very large screens */
            margin: 0 auto;
            /* Flex to grow and center content */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* This ensures the flex children (img, p) don't overflow this container */
            overflow: hidden; 
        }

        #chapter-title {
            font-family: 'Inter', sans-serif;
            font-size: clamp(1.25rem, 2vw, 2.5rem); /* -50% from original */
            font-weight: 600;
            color: #bbbbbb;

            position: fixed;          /* Stays in place when scrolling */
            top: 2rem;                /* Safe zone from top */
            left: 2rem;              /* Safe zone from right */

            margin: 0;                /* Remove bottom margin since it's fixed */
            z-index: 1000;            /* Keep above other content */
        }

        #verse-text { 
    color: #ffffff;
    margin-bottom: 2.5rem;
    
    /* --- Styles for the Image --- */
    filter: invert(1); 
    width: 100%;
    max-width: 1200px; /* Match the container */
    height: auto;      /* Let aspect ratio determine height */
    object-fit: contain;

    /* --- Dynamic Sizing Fix --- */
    flex-grow: 0;       /* Don't grow to fill space */
    flex-shrink: 1;     /* Shrink if space is tight */
    max-height: 60%;    /* Max 60% of the #content-display height */
    overflow: hidden;   /* Hide any potential overflow */

    /* --- Static Fixes --- */
    position: relative;         /* Stabilizes layout */
    will-change: auto;          /* Stop GPU re-render flickering */
    transition: none !important;
    transform: none !important; 
    backface-visibility: hidden;
    image-rendering: crisp-edges; 
    pointer-events: none;       
}



        #translation-text {
    font-family: 'Inter', sans-serif;
    font-size: clamp(1.6rem, 2.5vh, 3.5rem);
    font-weight: 1200;
    top: 35%;
    color: #dddddd;
    line-height: 1.7;

    /* --- Dynamic Sizing Fix --- */
    flex-grow: 0;       
    flex-shrink: 1;     
    max-height: 35%;    
    overflow: hidden;   

    /* --- Static Fixes --- */
    white-space: pre-wrap;       
    text-align: center;          
    position: relative;          
    will-change: auto;           
    transition: none !important; 
    transform: none !important;  
}  

/* --- Overlay to reduce visible flicker during PNG refresh --- */
#content-overlay {
    position: absolute;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.35); 
    backdrop-filter: blur(2px);      
    pointer-events: none;            
    z-index: 5;                      
    transition: opacity 0.3s ease;
}



        /* --- Control Panel (Hidden on Inactivity) --- */
        #control-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; 
            gap: 2rem;
            padding: 2.5rem;

            background-color: rgba(20, 20, 20, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);

            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            will-change: opacity, transform;
            z-index: 100;
        }

        /* State when user is idle */
        body.idle #control-panel {
            opacity: 0;
            transform: translateY(100%);
            pointer-events: none; /* Disable clicks when hidden */
        }

        #control-panel label {
            font-size: clamp(1.6rem, 2vw, 2.2rem);
            font-weight: 400;
            color: #ccc;
        }

        #control-panel select {
            font-family: 'Inter', sans-serif;
            font-size: clamp(1.8rem, 2.2vw, 2.4rem);
            padding: 1.2rem 1.5rem;
            background-color: #333;
            color: #ffffff;
            border: 1px solid #555;
            border-radius: 12px;
            cursor: pointer;
            min-width: 200px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1.5rem center;
            background-size: 1.6rem;
            padding-right: 4rem; /* Space for arrow */
        }

        /* --- TV Focus Styling --- */
        #control-panel select:focus {
            outline: 4px solid #00AFFF; /* Bright blue/cyan */
            outline-offset: 2px;
            box-shadow: 0 0 25px rgba(0, 175, 255, 0.7);
            background-color: #444;
        }


        /* --- Hidden Audio Players --- */
        #audio-player, #translation-audio-player {
            display: none;
        }

#verse-text, 
#verse-text-next {
  transition: opacity 0.3s ease;
  position: absolute;
  top: 15%; 
  left: 5%;
  width: 100%;
  height: auto;
}



    </style>
</head>

<body>
    <div class="container">
        <audio id="audio-player" controls></audio>
        <audio id="translation-audio-player" controls></audio>

<script>
function updateVerse(newSrc) {
  const current = document.getElementById('verse-text');
  const next = document.getElementById('verse-text-next');

  next.src = newSrc;
  next.onload = () => {
    current.style.opacity = '0';
    next.style.display = 'block';
    next.style.opacity = '1';
    setTimeout(() => {
      current.src = newSrc;
      next.style.display = 'none';
      current.style.opacity = '1';
    }, 300);
  };
}
</script>
        
        <div id="content-display">
            <h1 id="chapter-title">Loading...</h1>
            <p id="verse-text"></p>
            <img id="verse-text-next" style="display:none;">
            <p id="translation-text"></D>
        </div>
    </div>

    <div id="control-panel">
        <div>
            <label for="chapterSelect"></label>
            <select id="chapterSelect"></select>
        </div>
        <div>
            <label for="verseSelect"></label>
            <select id="verseSelect"></select>
        </div>
        <div>
            <label for="translationSelect"></label>
            <select id="translationSelect"></select>
        </div>
        <div>
            <label for="reciterSelect"></label>
            <select id="reciterSelect"></select>
        </div>
        <div>
            <label for="translationAudioSelect"></label>
            <select id="translationAudioSelect"></select>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const quranAudioPlayer = document.getElementById('audio-player');
        const translationAudioPlayer = document.getElementById('translation-audio-player');
        const chapterSelect = document.getElementById('chapterSelect');
        const verseSelect = document.getElementById('verseSelect');
        const translationSelect = document.getElementById('translationSelect');
        const reciterSelect = document.getElementById('reciterSelect');
        const translationAudioSelect = document.getElementById('translationAudioSelect');
        const chapterTitleEl = document.getElementById('chapter-title');
        const translationTextEl = document.getElementById('translation-text');
        const contentDisplayEl = document.getElementById('content-display');

        // --- Translation Configuration ---
        const TRANSLATIONS_CONFIG = {
            'en': { name: 'English (Sahih)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/3TM.xml' },
            'zh': { name: 'ä¸­æ–‡ (Jian)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/zh.jian.xml' },
            'es': { name: 'EspaÃ±ol (Garcia)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/es.garcia.xml' },
            'id': { name: 'Indonesian', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/id.indonesian.xml' }
        };

        // --- Reciter Configuration ---
        const RECITERS_CONFIG = {
            'alafasy': { name: 'Mishary Alafasy', path: 'Alafasy_128kbps' },
            'juhaynee': { name: 'Al Juhany', path: 'Abdullaah_3awwaad_Al-Juhaynee_128kbps' },
            'sudais': { name: 'As Sudais', path: 'Abdurrahmaan_As-Sudais_192kbps' },
            'ghamadi': { name: 'Al Ghamdi', path: 'Ghamadi_40kbps' },
            'abbad': { name: 'Fares Abbad', path: 'Fares_Abbad_64kbps' },
            'muaiqly': { name: 'Al Muaiqly', path: 'MaherAlMuaiqly128kbps' },
            'shuraym': { name: 'Ash Shuraym', path: 'Saood_ash-Shuraym_128kbps' },
            'basit': { name: 'Abdul Basit', path: 'Abdul_Basit_Murattal_192kbps' }
        };

        // --- Translation Audio Configuration ---
        const TRANSLATION_AUDIO_CONFIG = {
            'none': { name: 'No Audio Translation' },
            'en_walk': { name: 'English (Ibrahim Walk)', path: 'English/Sahih_Intnl_Ibrahim_Walk_192kbps' },
            'id_ministry': { name: 'Indonesian (Ministry)', path: 'httpIA://dn721906.ca.archive.org/0/items/AlQuran-terjemahan-indonesia-tanpa-bahasa-arab' }
        };

        // --- FTT URL ---
        const FTT_URL = 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/FTT.XML';

        // --- Application State ---
        let quranData = []; 
        let allTranslations = {};
        let currentChapterData = {};
        let inactivityTimer;
        let forbiddenToTranslateSet = new Set(); // Stores "chap-verse" keys

        // --- Inactivity Timer for Controls ---
        function showControls() {
            document.body.classList.remove('idle');
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                document.body.classList.add('idle');
            }, 5000); // 5 seconds
        }

        // --- Core Functions ---

        /**
         * Fetches and initializes all required data
         */
        async function initializeApp() {
            try {
                // 1. Fetch JSON data for chapters/verses
                const jsonResponse = await fetch('https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/2TM3TM.json');
                if (!jsonResponse.ok) throw new Error(`HTTP error! status: ${jsonResponse.status} for JSON`);
                const jsonData = await jsonResponse.json();
                quranData = jsonData.chapters;

                // --- 2. Fetch FTT (Forbidden To Translate) data ---
                console.log("Fetching FTT data from:", FTT_URL);
                try {
                    const fttResponse = await fetch(FTT_URL);
                    if (!fttResponse.ok) throw new Error(`HTTP error! status: ${fttResponse.status} for FTT.xml`);
                    const fttString = await fttResponse.text();
                    const parser = new DOMParser();
                    const fttDoc = parser.parseFromString(fttString, 'application/xml');
                    
                    // --- NEW: Check for XML parser errors ---
                    const parserError = fttDoc.querySelector('parsererror');
                    if (parserError) {
                        console.error('Error parsing FTT.xml:', parserError.textContent);
                        throw new Error("FTT.xml parser error");
                    }
                    // --- END NEW ---

                    const verses = fttDoc.querySelectorAll('Verse');
                    if (verses.length === 0) {
                         console.warn("No <Verse> elements found in FTT.xml. Check the file content.");
                    }

                    verses.forEach(verse => {
                        // --- MODIFIED: Added .trim() for robustness ---
                        const chapNum = verse.getAttribute('chapter')?.trim(); 
                        const verseNum = verse.getAttribute('number')?.trim();  
                        if (chapNum && verseNum) {
                            forbiddenToTranslateSet.add(`${chapNum}-${verseNum}`);
                        }
                    });

                    // --- NEW: Log the resulting Set for debugging ---
                    console.log(`ForbiddenToTranslate Set initialized. ${forbiddenToTranslateSet.size} verses loaded:`, forbiddenToTranslateSet);
                    // --- END NEW ---

                } catch (error) {
                    console.warn("Could not load FTT.xml, proceeding without it.", error);
                }
                // --- END FTT FETCH ---


                // 3. Fetch all translations in parallel
                console.log("Fetching all translations...");
                const translationPromises = Object.entries(TRANSLATIONS_CONFIG).map(async ([id, config]) => {
                    try {
                        const response = await fetch(config.url);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${config.name}`);
                        const xmlString = await response.text();
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlString, 'application/xml');
                        return { id, xmlDoc };
                    } catch (error) {
                        console.error(`Failed to load ${config.name}:`, error);
                        return { id, xmlDoc: null };
                    }
                });

                const settledTranslations = await Promise.all(translationPromises);

                // 4. Store translations and populate translation select
                allTranslations = {};
                translationSelect.innerHTML = ''; // Clear existing
                
                settledTranslations.forEach(result => {
                    if (result.xmlDoc) {
                        allTranslations[result.id] = result.xmlDoc;
                        const option = document.createElement('option');
                        option.value = result.id;
                        option.textContent = TRANSLATIONS_CONFIG[result.id].name;
                        translationSelect.appendChild(option);
                    }
                });

                if (Object.keys(allTranslations).length === 0) {
                    throw new Error("Failed to load any translations.");
                }

                // 5. Populate other selectors
                populateReciterSelect();
                populateTranslationAudioSelect();
                populateChapterSelect();
                populateVerseSelect(); 
                
                // 6. Load first verse
                loadVerse(); 
                
                // 7. Set up event listeners *after* data is loaded
                chapterSelect.addEventListener('change', () => {
                    populateVerseSelect();
                    loadVerse();
                });
                verseSelect.addEventListener('change', loadVerse);
                translationSelect.addEventListener('change', updateTranslationText);
                reciterSelect.addEventListener('change', updateQuranAudio);
                translationAudioSelect.addEventListener('change', updateTranslationAudio);

                // Split audio 'ended' listeners
                quranAudioPlayer.addEventListener('ended', handleQuranAudioEnd);
                translationAudioPlayer.addEventListener('ended', playNextVerse);

            } catch (error) {
                console.error("Failed to load Qur'an data:", error);
                contentDisplayEl.innerHTML = `
                    <h1 id="chapter-title">Error</h1>
                    <p id="translation-text">Failed to load Qur'an data. Please check your internet connection and refresh the page.</p>
                `;
            }
        }

        /**
         * Populates the Chapter dropdown
         */
        function populateChapterSelect() {
            chapterSelect.innerHTML = '';
            quranData.forEach((chapter, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${chapter.chapterNumber}. ${chapter.title} `;
                chapterSelect.appendChild(option);
            });
        }

        /**
         * Populates the Verse dropdown
         */
        function populateVerseSelect() {
            verseSelect.innerHTML = '';
            const chapterIndex = chapterSelect.value || 0;
            currentChapterData = quranData[chapterIndex]; 

            currentChapterData.verses.forEach((verse, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Ayat ${verse.verseNumber}`;
                verseSelect.appendChild(option);
            });
        }

        /**
         * Populates the Reciter dropdown from the config
         */
        function populateReciterSelect() {
            reciterSelect.innerHTML = '';
            Object.entries(RECITERS_CONFIG).forEach(([id, config]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = config.name;
                reciterSelect.appendChild(option);
            });
        }

        /**
         * Populates the Translation Audio dropdown from the config
         */
        function populateTranslationAudioSelect() {
            translationAudioSelect.innerHTML = ''; // Clear existing
            Object.entries(TRANSLATION_AUDIO_CONFIG).forEach(([id, config]) => {
                const option = document.createElement('option');
                option.value = id; // e.g., 'none', 'en_walk'
                option.textContent = config.name; // e.g., 'No Audio Translation'
                translationAudioSelect.appendChild(option);
            });
        }


        /**
         * Updates *only* the translation text content.
         */
        function updateTranslationText() {
            const chapterIndex = chapterSelect.value || 0;
            const verseIndex = verseSelect.value || 0;
            const translationId = translationSelect.value; 

            if (!quranData[chapterIndex] || !quranData[chapterIndex].verses[verseIndex] || !translationId) {
                return;
            }

            const chapNum = quranData[chapterIndex].chapterNumber;
            const verseNum = quranData[chapterIndex].verses[verseIndex].verseNumber;
            
            // --- FTT Check ---
            const verseKey = `${chapNum}-${verseNum}`;
            // console.log(`(text) Checking FTT for key: ${verseKey}`); // Optional: for more noise
            if (forbiddenToTranslateSet.has(verseKey)) {
                translationTextEl.textContent = '';
                adjustTranslationFontSize();
                return; // Stop here, do not show translation
            }
            // --- END FTT ---

            const selectedTranslationXML = allTranslations[translationId]; 
            let translation = "Translation not found.";
            if (selectedTranslationXML) {
                const suraElement = selectedTranslationXML.querySelector(`sura[index="${chapNum}"]`);
                if (suraElement) {
                    const ayaElement = suraElement.querySelector(`aya[index="${verseNum}"]`);
                    if (ayaElement) {
                        translation = ayaElement.getAttribute('text');
                    }
                }
            }
            translationTextEl.textContent = translation;

            adjustTranslationFontSize();
        }

        /**
         * Updates *only* the QUR'AN audio source
         */
        function updateQuranAudio() {
            const chapterIndex = chapterSelect.value || 0;
            const verseIndex = verseSelect.value || 0;
            const reciterId = reciterSelect.value;

            if (!quranData[chapterIndex] || !quranData[chapterIndex].verses[verseIndex] || !reciterId) {
                return;
            }

            const chapNum = quranData[chapterIndex].chapterNumber;
            const verseNum = quranData[chapterIndex].verses[verseIndex].verseNumber;
            const reciterPath = RECITERS_CONFIG[reciterId].path;

            const chapterStr = String(chapNum).padStart(3, '0');
            const verseStr = String(verseNum).padStart(3, '0');
            
            const newAudioUrl = `https://everyayah.com/data/${reciterPath}/${chapterStr}${verseStr}.mp3`;

            const wasPlaying = !quranAudioPlayer.paused;
            quranAudioPlayer.src = newAudioUrl;

            if (wasPlaying) {
                quranAudioPlayer.play().catch(e => console.warn("Audio autoplay blocked.", e));
            }
            
            updateMediaSession();
        }

        /**
         * Updates *only* the TRANSLATION audio source
         */
        function updateTranslationAudio() {
            const chapterIndex = chapterSelect.value || 0;
            const verseIndex = verseSelect.value || 0;

            // --- FTT Check ---
            if (quranData[chapterIndex] && quranData[chapterIndex].verses[verseIndex]) {
                 const chapNum = quranData[chapterIndex].chapterNumber;
                 const verseNum = quranData[chapterIndex].verses[verseIndex].verseNumber;
                 const verseKey = `${chapNum}-${verseNum}`;
                // console.log(`(audio) Checking FTT for key: ${verseKey}`); // Optional
                 if (forbiddenToTranslateSet.has(verseKey)) {
                    translationAudioPlayer.src = ''; // Clear src
                    return; // Exit function immediately
                 }
            }
            // --- END FTT ---

            const translationAudioId = translationAudioSelect.value;
            
            if (translationAudioId === 'none') {
                translationAudioPlayer.src = '';
                return;
            }
            
            if (!quranData[chapterIndex] || !quranData[chapterIndex].verses[verseIndex]) {
                return;
            }

            const chapNum = quranData[chapterIndex].chapterNumber;
            const verseNum = quranData[chapterIndex].verses[verseIndex].verseNumber;
            const config = TRANSLATION_AUDIO_CONFIG[translationAudioId];

            const chapterStr = String(chapNum).padStart(3, '0');
            const verseStr = String(verseNum).padStart(3, '0');
            
            let newAudioUrl;

            if (config.path.startsWith('httpIA')) { 
                newAudioUrl = `${config.path.replace('httpIA', 'https')}/${chapterStr}${verseStr}.mp3`;
            } else {
                newAudioUrl = `https://everyayah.com/data/${config.path}/${chapterStr}${verseStr}.mp3`;
            }

            const wasPlaying = !translationAudioPlayer.paused;
            translationAudioPlayer.src = newAudioUrl;

            if (wasPlaying) {
                translationAudioPlayer.play().catch(e => console.warn("Audio autoplay blocked.", e));
            }
        }


        /**
         * Loads the selected verse (image) and audio.
         */
        function loadVerse() {
            const chapterIndex = chapterSelect.value || 0;
            const verseIndex = verseSelect.value || 0;
            
            currentChapterData = quranData[chapterIndex];
            let verseData = currentChapterData.verses[verseIndex]; 

            const chapNum = currentChapterData.chapterNumber;
            const verseNum = verseData.verseNumber;

            // --- FTT Check ---
            const verseKey = `${chapNum}-${verseNum}`;
            const isForbidden = forbiddenToTranslateSet.has(verseKey);
            
            // --- NEW: Debugging ---
            console.log(`%cLoading Verse: ${verseKey} | IsForbidden: ${isForbidden}`, 'color: cyan; font-weight: bold;');
            // --- END NEW ---

            // --- Update Chapter Title ---
            chapterTitleEl.textContent = `${currentChapterData.title} (${chapNum})`;

            // --- Display Arabic as an Image ---
            const oldVerseEl = document.getElementById('verse-text');
            const verseImage = document.createElement('img');
            verseImage.id = 'verse-text';
            verseImage.src = `https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/img/${chapNum}_${verseNum}.png`;
            verseImage.alt = `Surah ${chapNum}, Verse ${verseNum}`;
            
            if (oldVerseEl) {
                oldVerseEl.parentNode.replaceChild(verseImage, oldVerseEl);
            } else {
                contentDisplayEl.insertBefore(verseImage, translationTextEl);
            }

            // --- Update Translation ---
            if (isForbidden) {
                translationTextEl.textContent = ''; // Clear text
            } else {
                updateTranslationText(); // Load as normal
            }
            
            // --- Update Audio ---
            const wasPlaying = !quranAudioPlayer.paused; 
            
            updateQuranAudio(); // This always loads
            
            if (isForbidden) {
                translationAudioPlayer.src = ''; // Clear audio source
            } else {
                updateTranslationAudio(); // Load as normal
            }

            // Only auto-play the Qur'an audio
            if (wasPlaying) {
                quranAudioPlayer.play().catch(e => console.warn("Audio autoplay blocked.", e));
            } else {
                 quranAudioPlayer.play().catch(e => console.warn("Audio autoplay blocked.", e));
            }

            // --- Update Page Title & Media Session ---
            updateTitle();
            updateMediaSession();
        }

        /**
         * Handles when the *Qur'an* audio finishes playing.
         */
        function handleQuranAudioEnd() {
            const translationAudioId = translationAudioSelect.value;
            
            if (translationAudioId === 'none' || translationAudioPlayer.src === '' || translationAudioPlayer.src.endsWith('/')) {
                // No translation selected, or src is empty (which it will be for FTT verses)
                playNextVerse();
            } else {
                // Translation is selected, play it
                translationAudioPlayer.play().catch(e => {
                    console.warn("Translation audio playback failed.", e);
                    playNextVerse();
                });
            }
        }

        /**
         * Automatically advances to the next verse when the current one ends.
         */
        function playNextVerse() {
            // console.log("Audio ended, advancing to next verse...");

            let currentChapterIndex = parseInt(chapterSelect.value);
            let currentVerseIndex = parseInt(verseSelect.value);

            const totalVersesInChapter = verseSelect.options.length;
            const totalChapters = chapterSelect.options.length;

            let nextVerseIndex = currentVerseIndex + 1;
            let nextChapterIndex = currentChapterIndex;

            if (nextVerseIndex >= totalVersesInChapter) {
                nextVerseIndex = 0;
                nextChapterIndex = currentChapterIndex + 1;

                if (nextChapterIndex >= totalChapters) {
                    console.log("End of Qur'an playback.");
                    return; // Stop at the end
                }
                
                chapterSelect.value = nextChapterIndex;
                populateVerseSelect();
            }

            verseSelect.value = nextVerseIndex;
            loadVerse();
        }
        
        /**
         * Dynamically adjusts the translation font size to fit its container
         */
        function adjustTranslationFontSize() {
            const el = translationTextEl;
            if (!el) return;

            const minFontSizePx = 1.6 * 10;
            const vhInPx = window.innerHeight * 0.025;
            const remInPx = 3.5 * 10;
            const maxFontSizePx = Math.min(vhInPx, remInPx);

            el.style.fontSize = `${maxFontSizePx}px`;

            let currentFontSize = maxFontSizePx;
            let iterations = 0;
            const maxIterations = 50; 

            while (el.scrollHeight > el.clientHeight && iterations < maxIterations) {
                currentFontSize -= 1; 
                if (currentFontSize < minFontSizePx) {
                    el.style.fontSize = `${minFontSizePx}px`;
                    break; 
                }
                el.style.fontSize = `${currentFontSize}px`;
                iterations++;
            }
        }


        /**
         * Updates the browser tab/window title
         */
        function updateTitle() {
            if (currentChapterData && currentChapterData.verses) {
                const verseIndex = verseSelect.value || 0;
                const verseNum = currentChapterData.verses[verseIndex].verseNumber;
                document.title = `Qur'an - ${currentChapterData.title} : ${verseNum}`;
            } else {
                document.title = "Qur'an";
            }
        }

        /**
         * Updates the OS-level Media Session for TV/mobile lock screens
         */
        function updateMediaSession() {
            if ('mediaSession' in navigator && currentChapterData && currentChapterData.verses) {
                const verseIndex = verseSelect.value || 0;
                const verseNum = currentChapterData.verses[verseIndex].verseNumber;
                
                const reciterId = reciterSelect.value;
                const reciterName = RECITERS_CONFIG[reciterId] ? RECITERS_CONFIG[reciterId].name : 'Qur\'an';

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: `Ayat ${verseNum}`,
                    artist: reciterName, 
                    album: `Surah ${currentChapterData.title}`,
                });
            }
        }

        /**
         * Handles viewport height changes
         */
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh * 100}px`);
        }

        // --- Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setViewportHeight();
        });

        window.addEventListener('resize', () => {
            setViewportHeight();
            adjustTranslationFontSize();
        });

        // --- Inactivity Listeners ---
        document.addEventListener('mousemove', showControls);
        document.addEventListener('keydown', showControls);
        document.addEventListener('touchstart', showControls);
        document.addEventListener('click', showControls);
        
        showControls();

    </script>
</body>
</html>
