<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quran Player</title>
    
    <meta name="description" content="Listen to the Noble Quran verse by verse.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">

    <link rel="canonical" href="https://muslim1446.github.io/">
    <link href="data:image/svg+xml,<svg xmlns=%22http://www.w.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>" rel="icon">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BR6YH9S6MS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BR6YH9S6MS');
    </script>

    <style>
        :root { --vh: 100vh; --accent: #00AFFF; --bg: #000000; --text: #eee; }
        html, body { height: 100%; margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overscroll-behavior: none;
            overflow: hidden;
        }

        /* --- Smart Loading Screen --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        
        .loader-content { text-align: center; }
        
        .loader-spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s infinite linear;
            margin: 0 auto 20px auto;
        }
        
        .start-btn {
            display: none; /* Hidden until loaded */
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 175, 255, 0.4);
            animation: pulse-btn 2s infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- Main Content --- */
        .container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; padding: 20px; padding-bottom: 100px;
        }

        #chapter-title {
            position: fixed; top: 20px; left: 20px;
            font-size: 1.2rem; color: #888; margin: 0;
        }

        #content-display {
            position: relative; width: 100%; max-width: 800px;
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center;
        }

        #verse-text, #verse-text-next { 
            filter: invert(1); width: 100%; object-fit: contain;
            max-height: 50vh; margin-bottom: 20px;
            transition: opacity 0.3s;
        }
        
        #verse-text-next { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; pointer-events: none; }

        #translation-text {
            color: #ccc; font-weight: 300; text-align: center;
            max-height: 30vh; overflow-y: auto; line-height: 1.5;
            padding: 0 10px;
        }

        /* --- Controls --- */
        #control-panel {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(20,20,20,0.95);
            padding: 15px;
            display: flex; gap: 10px; overflow-x: auto;
            border-top: 1px solid #333;
        }
        
        select {
            background: #333; color: white; border: 1px solid #444;
            padding: 10px; border-radius: 6px; font-size: 14px;
        }

        /* Hide Scrollbars */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader-content" id="loader-content">
            <div class="loader-spinner"></div>
            <div id="loader-text">Loading Quran Data...</div>
            <button id="start-btn" class="start-btn">Tap to Start</button>
        </div>
    </div>

    <div class="container">
        <h1 id="chapter-title"></h1>
        
        <div id="content-display">
            <img id="verse-text" alt="">
            <img id="verse-text-next" alt="">
            <div id="translation-text"></div>
        </div>
    </div>

    <audio id="audio-player"></audio>
    <audio id="translation-audio-player"></audio>

    <div id="control-panel">
        <select id="chapterSelect"></select>
        <select id="verseSelect"></select>
        <select id="translationSelect"></select>
        <select id="reciterSelect"></select>
        <select id="translationAudioSelect"></select>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // I have truncated the list for brevity, but the logic handles your full list.
        // You can paste your full TRANSLATIONS_CONFIG back here.
        const TRANSLATIONS_CONFIG = {
    'sq': { name: 'Albanian (Sherif Ahmeti)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/sq.ahmeti.xml' },
    'ber': { name: 'Amazigh (At Mansour)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ber.mensur.xml' },
    'am': { name: 'Amharic (Sadiq & Sani)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/am.sadiq.xml' },
    'ar': { name: 'Arabic Tafsir (Al-Muyassar)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ar.muyassar.xml' },
    'az': { name: 'Azerbaijani (Musayev)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/az.musayev.xml' },
    'bn': { name: 'Bengali (Muhiuddin Khan)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/bn.bengali.xml' },
    'bs': { name: 'Bosnian (Besim Korkut)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/bs.korkut.xml' },
    'bg': { name: 'Bulgarian (Theophanov)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/bg.theophanov.xml' },
    'zh': { name: 'Chinese (Ma Jian)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/zh.jian.xml' },
    'cs': { name: 'Czech (Hrbek)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/cs.hrbek.xml' },
    'dv': { name: 'Divehi (Maldives President Office)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/dv.divehi.xml' },
    'nl': { name: 'Dutch (Siregar)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/nl.siregar.xml' },
    'en': { name: 'English (Saheeh International)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/en.sahih.xml' },
    'fr': { name: 'French (Muhammad Hamidullah)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/fr.hamidullah.xml' },
    'de': { name: 'German (Bubenheim & Elyas)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/de.bubenheim.xml' },
    'ha': { name: 'Hausa (Gumi)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ha.gumi.xml' },
    'hi': { name: 'Hindi (Suhel Farooq Khan)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/hi.hindi.xml' },
    'id': { name: 'Indonesian (Ministry of Religious Affairs)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/id.indonesian.xml' },
    'it': { name: 'Italian (Piccardo)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/it.piccardo.xml' },
    'ja': { name: 'Japanese (Standard)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ja.japanese.xml' },
    'ko': { name: 'Korean (Standard)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ko.korean.xml' },
    'ku': { name: 'Kurdish (Burhan Muhammad-Amin)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ku.asan.xml' },
    'ms': { name: 'Malay (Basmeih)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ms.basmeih.xml' },
    'ml': { name: 'Malayalam (Abdul Hameed)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ml.abdulhameed.xml' },
    'no': { name: 'Norwegian (Berg)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/no.berg.xml' },
    'ps': { name: 'Pashto (Abdulwali Khan)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ps.abdulwali.xml' },
    'fa': { name: 'Persian (Mostafa Khorramdel)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/fa.khorramdel.xml' },
    'pl': { name: 'Polish (Bielawskiego)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/pl.bielawskiego.xml' },
    'pt': { name: 'Portuguese (El-Hayek)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/pt.elhayek.xml' },
    'ro': { name: 'Romanian (Grigore)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ro.grigore.xml' },
    'ru': { name: 'Russian (Elmir Kuliev)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ru.kuliev.xml' },
    'sd': { name: 'Sindhi (Amroti)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/sd.amroti.xml' },
    'so': { name: 'Somali (Abduh)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/so.abduh.xml' },
    'es': { name: 'Spanish (Muhammad Isa GarcÃ­a)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/es.garcia.xml' },
    'sw': { name: 'Swahili (Al-Barwani)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/sw.barwani.xml' },
    'sv': { name: 'Swedish (BernstrÃ¶m)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/sv.bernstrom.xml' },
    'ta': { name: 'Tamil (Jan Turst)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ta.tamil.xml' },
    'tt': { name: 'Tatar (Nugman)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/tt.nugman.xml' },
    'th': { name: 'Thai (King Fahad Complex)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/th.thai.xml' },
    'tr': { name: 'Turkish (Diyanet)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/tr.diyanet.xml' },
    'ur': { name: 'Urdu (Muhammad Junagarhi)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ur.junagarhi.xml' },
    'ug': { name: 'Uyghur (Muhammad Saleh)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ug.saleh.xml' },
    'uz': { name: 'Uzbek (Muhammad Sodik)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/uz.sodik.xml' }
        };

        const RECITERS_CONFIG = {
            'alafasy': { name: 'Mishary Alafasy', path: 'Alafasy_128kbps' },
            'juhaynee': { name: 'Al Juhany', path: 'Abdullaah_3awwaad_Al-Juhaynee_128kbps' },
            'sudais': { name: 'As Sudais', path: 'Abdurrahmaan_As-Sudais_192kbps' },
            'ghamadi': { name: 'Al Ghamdi', path: 'Ghamadi_40kbps' },
            'abbad': { name: 'Fares Abbad', path: 'Fares_Abbad_64kbps' },
            'muaiqly': { name: 'Al Muaiqly', path: 'MaherAlMuaiqly128kbps' },
            'shuraym': { name: 'Ash Shuraym', path: 'Saood_ash-Shuraym_128kbps' },
            'basit': { name: 'Abdul Basit', path: 'Abdul_Basit_Murattal_192kbps' }
        };

        const TRANSLATION_AUDIO_CONFIG = {
            'none': { name: 'No Audio Translation' },
            'en_walk': { name: 'English (Ibrahim Walk)', path: 'English/Sahih_Intnl_Ibrahim_Walk_192kbps' },
            'id_ministry': { name: 'Indonesian (Ministry)', path: 'httpIA://dn721906.ca.archive.org/0/items/AlQuran-terjemahan-indonesia-tanpa-bahasa-arab' },
            'es_custom': { name: 'EspaÃ±ol', path: 'custom_es_url' }
        };

        // --- 2. STATE ---
        let quranData = [];
        let allTranslations = {};
        let forbiddenSet = new Set();
        
        const els = {
            overlay: document.getElementById('loading-overlay'),
            spinner: document.querySelector('.loader-spinner'),
            loaderText: document.getElementById('loader-text'),
            startBtn: document.getElementById('start-btn'),
            
            audio: document.getElementById('audio-player'),
            transAudio: document.getElementById('translation-audio-player'),
            
            sel: {
                ch: document.getElementById('chapterSelect'),
                v: document.getElementById('verseSelect'),
                trans: document.getElementById('translationSelect'),
                rec: document.getElementById('reciterSelect'),
                tAud: document.getElementById('translationAudioSelect')
            },
            
            disp: {
                title: document.getElementById('chapter-title'),
                img: document.getElementById('verse-text'),
                nextImg: document.getElementById('verse-text-next'),
                txt: document.getElementById('translation-text')
            }
        };

        // --- 3. INITIALIZATION ---
        async function init() {
            try {
                // Fetch Core Data
                const [jsonRes, fttRes] = await Promise.all([
                    fetch('https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/2TM3TM.json'),
                    fetch('https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/FTT.XML')
                ]);

                const jsonData = await jsonRes.json();
                quranData = jsonData.chapters;

                const fttText = await fttRes.text();
                new DOMParser().parseFromString(fttText, "text/xml")
                    .querySelectorAll('Verse').forEach(v => 
                        forbiddenSet.add(`${v.getAttribute('chapter')}-${v.getAttribute('number')}`)
                    );

                // Fetch Translations (All at once)
                await Promise.all(Object.keys(TRANSLATIONS_CONFIG).map(async key => {
                    try {
                        const res = await fetch(TRANSLATIONS_CONFIG[key].url);
                        if(res.ok) allTranslations[key] = new DOMParser().parseFromString(await res.text(), "text/xml");
                    } catch(e){}
                }));

                // Populate UI
                populateUI();
                
                // SMART RESTORE (Fixes the Default Language Issue)
                smartRestore();

                // Ready to Start
                els.spinner.style.display = 'none';
                els.loaderText.style.display = 'none';
                els.startBtn.style.display = 'block';
                
                // Update Button Text based on Memory
                const saved = JSON.parse(localStorage.getItem('quranState'));
                if(saved && saved.chapter) {
                    els.startBtn.textContent = `Resume Surah ${quranData[saved.chapter].title}`;
                } else {
                    els.startBtn.textContent = "Start Listening";
                }

                // Pre-load the first image (but don't play yet)
                loadVerse(false);

            } catch (e) {
                els.loaderText.textContent = "Error loading data. Check connection.";
            }
        }

        // --- 4. SMART LOGIC ---
        function populateUI() {
            // Chapters
            els.sel.ch.innerHTML = quranData.map((c, i) => `<option value="${i}">${c.chapterNumber}. ${c.title}</option>`).join('');
            // Reciters
            els.sel.rec.innerHTML = Object.entries(RECITERS_CONFIG).map(([k,v]) => `<option value="${k}">${v.name}</option>`).join('');
            // Audio Trans
            els.sel.tAud.innerHTML = Object.entries(TRANSLATION_AUDIO_CONFIG).map(([k,v]) => `<option value="${k}">${v.name}</option>`).join('');
            // Text Trans
            els.sel.trans.innerHTML = Object.entries(TRANSLATIONS_CONFIG).map(([k,v]) => `<option value="${k}">${v.name}</option>`).join('');
        }

        function smartRestore() {
            const saved = JSON.parse(localStorage.getItem('quranState')) || {};
            const urlParams = new URLSearchParams(window.location.search);
            const browserLang = navigator.language.split('-')[0]; // e.g., 'es' from 'es-ES'

            // 1. Restore Chapter/Verse
            if(saved.chapter) els.sel.ch.value = saved.chapter;
            populateVerses(); // Must run to fill verse select
            if(saved.verse) els.sel.v.value = saved.verse;

            // 2. Restore Reciter
            if(saved.reciter) els.sel.rec.value = saved.reciter;

            // 3. INTELLIGENT LANGUAGE DETECTION (The Fix)
            let targetLang = 'en'; // Hard fallback to English (NOT 'sq')

            // Priority: URL > Saved > Browser > English
            if (urlParams.has('trans') && TRANSLATIONS_CONFIG[urlParams.get('trans')]) {
                targetLang = urlParams.get('trans');
            } else if (saved.trans && TRANSLATIONS_CONFIG[saved.trans]) {
                targetLang = saved.trans;
            } else if (TRANSLATIONS_CONFIG[browserLang]) {
                targetLang = browserLang; // Auto-detect!
            }

            // Force the select box to this value
            els.sel.trans.value = targetLang;
        }

        function populateVerses() {
            const chIdx = els.sel.ch.value;
            els.sel.v.innerHTML = quranData[chIdx].verses.map((v, i) => `<option value="${i}">Ayat ${v.verseNumber}</option>`).join('');
        }

        // --- 5. PLAYER ENGINE ---
        function loadVerse(shouldPlay) {
            const chIdx = els.sel.ch.value;
            const vIdx = els.sel.v.value;
            const chData = quranData[chIdx];
            const vData = chData.verses[vIdx];
            const chNum = chData.chapterNumber;
            const vNum = vData.verseNumber;

            // Update Text
            els.disp.title.textContent = `${chData.title} (${chNum}:${vNum})`;
            
            // Image Crossfade
            const newSrc = `https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/img/${chNum}_${vNum}.png`;
            els.disp.nextImg.src = newSrc;
            els.disp.nextImg.onload = () => {
                els.disp.img.style.opacity = 0;
                els.disp.nextImg.style.opacity = 1;
                setTimeout(() => {
                    els.disp.img.src = newSrc;
                    els.disp.img.style.opacity = 1;
                    els.disp.nextImg.style.opacity = 0;
                }, 300);
            };
            if(!els.disp.img.src) els.disp.img.src = newSrc;

            // Translation Text
            const tKey = els.sel.trans.value;
            const isForbidden = forbiddenSet.has(`${chNum}-${vNum}`);
            
            if(isForbidden) {
                els.disp.txt.textContent = "";
            } else if (allTranslations[tKey]) {
                const doc = allTranslations[tKey];
                const s = doc.querySelector(`sura[index="${chNum}"]`);
                const a = s ? s.querySelector(`aya[index="${vNum}"]`) : null;
                els.disp.txt.textContent = a ? a.getAttribute('text') : "Translation unavailable";
            }

            // Audio Prep
            const rPath = RECITERS_CONFIG[els.sel.rec.value].path;
            const padCh = String(chNum).padStart(3, '0');
            const padV = String(vNum).padStart(3, '0');
            els.audio.src = `https://everyayah.com/data/${rPath}/${padCh}${padV}.mp3`;

            // Trans Audio Prep
            if(!isForbidden && els.sel.tAud.value !== 'none') {
                const tPath = TRANSLATION_AUDIO_CONFIG[els.sel.tAud.value].path;
                els.transAudio.src = `https://everyayah.com/data/${tPath}/${padCh}${padV}.mp3`;
            } else {
                els.transAudio.src = "";
            }

            // SAVE STATE
            localStorage.setItem('quranState', JSON.stringify({
                chapter: parseInt(chIdx),
                verse: parseInt(vIdx),
                trans: tKey,
                reciter: els.sel.rec.value
            }));

            // PLAY LOGIC
            if(shouldPlay) {
                els.audio.play().catch(e => console.log("Autoplay blocked by browser policy"));
            }
        }

        function nextVerse() {
            const vSelect = els.sel.v;
            if(vSelect.selectedIndex < vSelect.options.length - 1) {
                vSelect.selectedIndex++;
                loadVerse(true);
            } else {
                // Next Chapter logic
                const cSelect = els.sel.ch;
                if(cSelect.selectedIndex < cSelect.options.length - 1) {
                    cSelect.selectedIndex++;
                    populateVerses();
                    els.sel.v.selectedIndex = 0;
                    loadVerse(true);
                }
            }
        }

        // --- 6. EVENT LISTENERS ---
        
        // The "User Gesture" that unlocks audio
        els.startBtn.addEventListener('click', () => {
            els.overlay.style.opacity = 0;
            setTimeout(() => els.overlay.style.display = 'none', 500);
            loadVerse(true); // NOW we play audio
        });

        els.sel.ch.addEventListener('change', () => { populateVerses(); loadVerse(true); });
        els.sel.v.addEventListener('change', () => loadVerse(true));
        els.sel.rec.addEventListener('change', () => loadVerse(els.audio.paused === false));
        
        // Translation change only updates text/state, doesn't restart audio
        els.sel.trans.addEventListener('change', () => { 
            loadVerse(false); // Update text
        });

        // Audio Chaining
        els.audio.addEventListener('ended', () => {
            if(els.transAudio.src && els.transAudio.src !== window.location.href) {
                els.transAudio.play().catch(() => nextVerse());
            } else {
                nextVerse();
            }
        });
        els.transAudio.addEventListener('ended', nextVerse);

        // Run
        init();

    </script>
</body>
</html>
