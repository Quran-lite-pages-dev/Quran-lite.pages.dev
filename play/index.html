<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Audio Tagger (v4 - Shortcuts Fixed)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: grid;
            grid-template-areas:
                "header"
                "player"
                "clips"
                "io";
            grid-template-rows: auto auto 1fr auto;
            gap: 15px;
            padding: 15px;
            background-color: #f4f4f4;
            color: #333;
            height: 95vh;
        }

        header { grid-area: header; }
        #player-controls { grid-area: player; }
        #clips-section { grid-area: clips; display: flex; flex-direction: column; min-height: 200px; }
        #io-section { grid-area: io; }

        h1, h2 {
            margin: 0 0 10px 0;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
        }

        #player-controls {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #chapter-select {
            font-size: 1.2em;
            padding: 5px;
            margin-right: 10px;
        }

        #tag-status {
            padding: 10px 15px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 5px;
            color: #fff;
            display: inline-block;
            width: 300px;
            text-align: center;
        }

        #time-display {
            font-family: "Courier New", Courier, monospace;
            font-size: 1.5em;
            font-weight: bold;
            color: #004a99;
            margin-left: 20px;
        }

        /* This is where the waveform will live */
        #waveform {
            width: 100%;
            height: 128px; /* You can change this height */
            margin-top: 15px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        
        #loading-indicator {
            font-size: 1.1em;
            font-weight: bold;
            color: #d9534f;
            display: none; /* Hidden by default */
            margin-left: 20px;
        }

        #clips-section {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        #clips-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        #clips-list li {
            font-family: "Courier New", Courier, monospace;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        #clips-list li:nth-child(odd) { background-color: #f9f9f9; }
        #clips-list li button { margin-left: 15px; cursor: pointer; }

        #io-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        #io-section > div {
            display: flex;
            flex-direction: column;
        }
        #io-section textarea {
            width: 100%;
            height: 150px;
            font-family: "Courier New", Courier, monospace;
            box-sizing: border-box; /* Ensures padding doesn't affect width */
        }
        #import-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 5px;
        }
        #import-button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <header>
        <h1>üéß Online Audio Tagger (v4 - Shortcuts Fixed)</h1>
    </header>

    <section id="player-controls">
        <label for="chapter-select">Chapter:</label>
        <select id="chapter-select"></select>

        <span id="tag-status"></span>
        <span id="time-display">00:00:00.000</span>
        <span id="loading-indicator">Decoding Waveform...</span>
        
        <div id="waveform"></div>
        
        <div>
            <strong>Shortcuts:</strong> 
            [Space]: Play/Pause |
            [‚Üê]: Rewind 1s |
            [‚Üí]: Forward 1s |
            [1]: Mark Arabic End |
            [2]: Mark Spanish End
        </div>
    </section>

    <section id="clips-section">
        <h2>Marked Clips for <span id="current-chapter-title">...</span></h2>
        <ul id="clips-list">
            </ul>
    </section>

    <section id="io-section">
        <div>
            <h2>Import JSON</h2>
            <textarea id="import-json" placeholder="Paste your timestamps.json content here..."></textarea>
            <button id="import-button">Import and Overwrite</button>
        </div>
        <div>
            <h2>Live JSON Export</h2>
            <textarea id="export-json" readonly placeholder="Your timestamp JSON will appear here..."></textarea>
        </div>
    </section>

    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>

    <script>
        // --- GLOBALS ---
        const chapterSelect = document.getElementById('chapter-select');
        const tagStatus = document.getElementById('tag-status');
        const timeDisplay = document.getElementById('time-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const clipsList = document.getElementById('clips-list');
        const currentChapterTitle = document.getElementById('current-chapter-title');
        const importJsonText = document.getElementById('import-json');
        const exportJsonText = document.getElementById('export-json');
        const importButton = document.getElementById('import-button');
        
        let wavesurfer = null; // This will be our WaveSurfer instance
        let db = {}; // Master database for all timestamps
        let playerState = { currentFile: null, currentTime: 0 }; // Last known state
        let taggingState = 'orange'; // 'orange' (waiting for 1) or 'green' (waiting for 2)
        let currentStartTime = null;

        // --- CORE FUNCTIONS ---

        /**
         * Formats seconds into HH:MM:SS.mmm format
         * @param {number} seconds - The time in seconds
         * @returns {string} Formatted time string
         */
        function formatTime(seconds) {
            const ms = Math.floor((seconds % 1) * 1000);
            const totalSec = Math.floor(seconds);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(3, '0')}.${ms.toString().padStart(3, '0')}`;
        }

        /**
         * Saves the entire timestamp database to localStorage and updates the export box
         */
        function saveDB() {
            try {
                const jsonString = JSON.stringify(db, null, 2);
                localStorage.setItem('timestampDB', jsonString);
                exportJsonText.value = jsonString;
            } catch (e) {
                console.error("Failed to save DB:", e);
                alert("Error saving database. Your data might be too large for localStorage.");
            }
        }

        /**
         * Loads the timestamp database from localStorage
         */
        function loadDB() {
            const storedDB = localStorage.getItem('timestampDB');
            if (storedDB) {
                try {
                    db = JSON.parse(storedDB);
                    exportJsonText.value = JSON.stringify(db, null, 2);
                } catch (e)
                {
                    console.error("Failed to parse stored DB:", e);
                    db = {};
                }
            } else {
                db = {};
            }
        }

        /**
         * Saves the current player state (file and time) to localStorage
         */
        function savePlayerState() {
            // Get current time from wavesurfer if it exists
            if (wavesurfer) {
                playerState.currentTime = wavesurfer.getCurrentTime();
            }
            localStorage.setItem('playerState', JSON.stringify(playerState));
        }

        /**
         * Loads the last player state from localStorage
         */
        function loadPlayerState() {
            const storedState = localStorage.getItem('playerState');
            if (storedState) {
                try {
                    playerState = JSON.parse(storedState);
                } catch (e) {
                    console.error("Failed to parse player state:", e);
                    playerState = { currentFile: null, currentTime: 0 };
                }
            }
        }

        /**
         * Populates the chapter select dropdown (1-114)
         */
        function populateChapterSelect() {
            for (let i = 1; i <= 114; i++) {
                const chapterNum = i.toString().padStart(3, '0');
                const option = document.createElement('option');
                option.value = chapterNum;
                option.text = `Chapter ${chapterNum}`;
                chapterSelect.appendChild(option);
            }
        }

        /**
         * Initializes the WaveSurfer player
         */
        function initWaveSurfer() {
            if (wavesurfer) {
                wavesurfer.destroy();
            }
            
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: 'rgb(200, 200, 200)',
                progressColor: 'rgb(100, 100, 100)',
                height: 128,
                barWidth: 2,
                barGap: 1,
                cursorWidth: 2,
                cursorColor: '#004a99'
            });

            // --- WaveSurfer Event Listeners ---
            
            wavesurfer.on('ready', () => {
                loadingIndicator.style.display = 'none';
                console.log('Waveform ready.');
                // Restore last saved time
                wavesurfer.setTime(playerState.currentTime);
                timeDisplay.textContent = formatTime(playerState.currentTime);
            });
            
            wavesurfer.on('loading', (percent) => {
                loadingIndicator.textContent = `Decoding Waveform... ${percent}%`;
                loadingIndicator.style.display = 'inline';
            });

            wavesurfer.on('timeupdate', (currentTime) => {
                timeDisplay.textContent = formatTime(currentTime);
                // Save state continuously
                playerState.currentTime = currentTime;
                savePlayerState();
            });

            wavesurfer.on('error', (err) => {
                console.error('Wavesurfer error:', err);
                loadingIndicator.textContent = `Error loading file. Check console.`;
            });
        }
        
        /**
         * Loads a new chapter into the audio player
         * @param {string} chapterNum - The 3-digit chapter number (e.g., "001")
         */
        function loadChapter(chapterNum) {
            const fileName = `coran_${chapterNum}.mp3`;
            const filePath = `https://ia601404.us.archive.org/34/items/elsagrado/${fileName}`;
            
            playerState.currentFile = fileName; // We still save the local-style name for the DB
            playerState.currentTime = 0; // Reset on new chapter load
            savePlayerState();
            
            currentChapterTitle.textContent = `coran_${chapterNum}`;
            
            // Load the new audio file into wavesurfer
            // We MUST add a dummy parameter to bypass browser cache for archive.org
            wavesurfer.load(filePath + '?t=' + new Date().getTime());

            renderCurrentChapterClips();
            updateTagStatusUI('orange'); // Reset tag state
        }

        /**
         * Renders the list of marked clips for the currently loaded chapter
         */
        function renderCurrentChapterClips() {
            clipsList.innerHTML = ''; // Clear existing list
            if (!playerState.currentFile) return;

            const chapterKey = playerState.currentFile.split('.')[0]; // e.g., "coran_001"
            const clips = db[chapterKey] || [];

            if (clips.length === 0) {
                clipsList.innerHTML = '<li>No clips marked for this chapter yet.</li>';
            } else {
                clips.forEach(clip => {
                    const li = document.createElement('li');
                    li.textContent = `Verse ${clip.verse}: ${clip.start}  ‚Üí  ${clip.end}`;
                    
                    // Add a jump-to button
                    const jumpBtn = document.createElement('button');
                    jumpBtn.textContent = 'Jump to Start';
                    jumpBtn.onclick = () => {
                        wavesurfer.setTime(timeStringToSeconds(clip.start));
                        wavesurfer.play();
                    };
                    li.appendChild(jumpBtn);

                    // Add a delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.style.color = 'red';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`Delete Verse ${clip.verse}?`)) {
                            deleteClip(chapterKey, clip.verse);
                        }
                    };
                    li.appendChild(deleteBtn);

                    clipsList.appendChild(li);
                });
            }
        }

        /**
         * Deletes a specific clip and re-numbers subsequent verses
         * @param {string} chapterKey - e.g., "coran_001"
         * @param {number} verseToDelete - The verse number to delete
         */
        function deleteClip(chapterKey, verseToDelete) {
            if (!db[chapterKey]) return;

            // Filter out the deleted verse
            let chapterClips = db[chapterKey];
            chapterClips = chapterClips.filter(clip => clip.verse !== verseToDelete);

            // Re-number all subsequent verses
            chapterClips.forEach((clip, index) => {
                clip.verse = index + 1;
            });

            db[chapterKey] = chapterClips;
            saveDB();
            renderCurrentChapterClips();
        }

        /**
         * Converts "HH:MM:SS.mmm" string to seconds
         * @param {string} timeString
         * @returns {number} Time in seconds
         */
        function timeStringToSeconds(timeString) {
            const parts = timeString.split(':');
            const secondsAndMs = parseFloat(parts[2]);
            return (parseInt(parts[0]) * 3600) + (parseInt(parts[1]) * 60) + secondsAndMs;
        }

        /**
         * Updates the status indicator UI
         * @param {string} state - 'orange' or 'green'
         */
        function updateTagStatusUI(state) {
            taggingState = state;
            if (state === 'orange') {
                tagStatus.style.backgroundColor = 'orange';
                tagStatus.style.color = '#333';
                // --- THIS WAS THE BUG ---
                // It used to say 'tagGag.textContent'
                tagStatus.textContent = 'Waiting for Arabic End (Press 1)';
                // -----------------------
            } else {
                tagStatus.style.backgroundColor = 'lightgreen';
                tagStatus.style.color = '#333';
                tagStatus.textContent = 'Waiting for Spanish End (Press 2)';
            }
        }

        /**
         * Handles the "Mark Start" action (Key '1')
         */
        function handleMarkStart() {
            if (taggingState !== 'orange') {
                console.warn("Ignored '1' press: not in correct state.");
                return; // Can only mark start from orange state
            }
            currentStartTime = wavesurfer.getCurrentTime();
            updateTagStatusUI('green');
            console.log(`Marked START at ${formatTime(currentStartTime)}`);
        }

        /**
         * Handles the "Mark End" action (Key '2')
         */
        function handleMarkEnd() {
            if (taggingState !== 'green') {
                console.warn("Ignored '2' press: no start time marked.");
                return; // Can only mark end from green state
            }
            
            const endTime = wavesurfer.getCurrentTime();
            if (endTime <= currentStartTime) {
                alert("End time must be after start time.");
                return;
            }

            const chapterKey = playerState.currentFile.split('.')[0];
            if (!db[chapterKey]) {
                db[chapterKey] = [];
            }
            
            const verseNum = db[chapterKey].length + 1;
            const newClip = {
                verse: verseNum,
                start: formatTime(currentStartTime),
                end: formatTime(endTime)
            };

            db[chapterKey].push(newClip);
            saveDB(); // Save and update export box
            renderCurrentChapterClips(); // Update UI list

            console.log(`Saved CLIP ${verseNum}: ${newClip.start} -> ${newClip.end}`);

            // Reset for next clip
            currentStartTime = null;
            updateTagStatusUI('orange');
        }

        /**
         * Handles global key presses for shortcuts
         * @param {KeyboardEvent} e
         */
        function handleGlobalKeydown(e) {
            // If user is typing in the import box, don't trigger shortcuts
            if (e.target === importJsonText) {
                return;
            }
            if (!wavesurfer) return; // Don't do anything if player not ready

            switch (e.key) {
                case ' ':
                    e.preventDefault();
                    wavesurfer.playPause();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    wavesurfer.skip(-1); // Skip backward 1 second
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    wavesurfer.skip(1); // Skip forward 1 second
                    break;
                case '1':
                    e.preventDefault();
                    handleMarkStart();
                    break;
                case '2':
                    e.preventDefault();
                    handleMarkEnd();
                    break;
            }
        }

        /**
         * Handles the click on the Import button
         */
        function handleImport() {
            const jsonToImport = importJsonText.value;
            if (!jsonToImport) {
                alert("Import box is empty.");
                return;
            }
            if (!confirm("This will OVERWRITE all locally saved data. Are you sure?")) {
                return;
            }

            try {
                const newData = JSON.parse(jsonToImport);
                db = newData; // Overwrite in-memory DB
                saveDB(); // Save to localStorage and update export box
                renderCurrentChapterClips(); // Re-render UI
                importJsonText.value = ""; // Clear import box
                alert("Import successful! All data has been overwritten.");
            } catch (e) {
                console.error("Import failed:", e);
                alert("Import failed. The JSON seems to be invalid. Check console for details.");
            }
        }

        // --- INITIALIZATION ---
        
        window.addEventListener('load', () => {
            // 1. Populate UI elements
            populateChapterSelect();

            // 2. Load data from localStorage
            loadDB();
            loadPlayerState();

            // 3. Initialize WaveSurfer
            initWaveSurfer();
            
            // 4. Restore state
            if (playerState.currentFile) {
                const chapterNum = playerState.currentFile.split('_')[1].split('.')[0];
                chapterSelect.value = chapterNum;
                currentChapterTitle.textContent = `coran_${chapterNum}`;
                
                // Load the audio, and the 'ready' event will handle setting the time
                const fileName = `coran_${chapterNum}.mp3`;
                const filePath = `https://ia601404.us.archive.org/34/items/elsagrado/${fileName}`;
                wavesurfer.load(filePath + '?t=' + new Date().getTime());
            
            } else {
                // Load the first chapter by default if no state
                chapterSelect.value = "001";
                loadChapter("001");
            }
            
            // 5. Render initial data
            renderCurrentChapterClips();
            updateTagStatusUI('orange');

            // 6. Attach event listeners
            // This line is now reachable because the typo is fixed!
            document.addEventListener('keydown', handleGlobalKeydown);
            chapterSelect.addEventListener('change', (e) => loadChapter(e.target.value));
            importButton.addEventListener('click', handleImport);
        });

    </script>
</body>
</html>
